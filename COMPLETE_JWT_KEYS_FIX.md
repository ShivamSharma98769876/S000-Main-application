# Complete JWT Keys Fix - Step by Step

## Current Status
- ‚úÖ App will now start even if JWT keys are invalid
- ‚ùå OAuth login will fail until keys are properly configured
- ‚úÖ Error messages will guide you to fix the issue

## Step-by-Step Fix

### Step 1: Access Azure Kudu Console

1. Go to **Azure Portal** ‚Üí **Your App Service** (`a000-main-app`)
2. Click **Advanced Tools** ‚Üí Click **Go** (opens Kudu in new tab)
3. Click **Debug console** ‚Üí **CMD**

### Step 2: Navigate to Backend

In Kudu console, type:
```bash
cd site\wwwroot\backend
```

### Step 3: Generate RSA Keys

Generate fresh RSA keys:
```bash
node scripts/generate-keys.js
```

You should see:
```
‚úÖ RSA key pair generated successfully!
üìÅ Private key: backend/config/keys/private.pem
üìÅ Public key: backend/config/keys/public.pem
```

### Step 4: Display Private Key

```bash
type config\keys\private.pem
```

**IMPORTANT:** 
- Select and copy **ALL** the output
- It should start with `-----BEGIN PRIVATE KEY-----`
- It should end with `-----END PRIVATE KEY-----`
- It should be **1600+ characters** long
- Copy **every single line**

### Step 5: Display Public Key

```bash
type config\keys\public.pem
```

**IMPORTANT:**
- Select and copy **ALL** the output
- It should start with `-----BEGIN PUBLIC KEY-----`
- It should end with `-----END PUBLIC KEY-----`
- Copy **every single line**

### Step 6: Update Azure Portal

1. Go to **Azure Portal** ‚Üí **Your App Service** ‚Üí **Configuration** ‚Üí **Application settings**

2. **Find or Add `JWT_PRIVATE_KEY`:**
   - If it exists: Click **Edit**
   - If not: Click **+ New application setting**
   - **Name**: `JWT_PRIVATE_KEY`
   - **Value**: Paste the **ENTIRE** private key from Step 4
   - **IMPORTANT**: Make sure you paste the complete key (all lines)
   - Click **OK**

3. **Find or Add `JWT_PUBLIC_KEY`:**
   - If it exists: Click **Edit**
   - If not: Click **+ New application setting**
   - **Name**: `JWT_PUBLIC_KEY`
   - **Value**: Paste the **ENTIRE** public key from Step 5
   - **IMPORTANT**: Make sure you paste the complete key (all lines)
   - Click **OK**

4. **Click "Save"** at the top of the page

5. **Wait 1-2 minutes** for the app to restart automatically

### Step 7: Verify Keys Are Valid

Go back to Kudu Console and run:
```bash
node scripts/check-jwt-keys-azure.js
```

You should see:
```
‚úÖ JWT_PRIVATE_KEY is VALID!
‚úÖ JWT_PUBLIC_KEY is VALID!
‚úÖ JWT keys are properly configured!
```

### Step 8: Check Application Logs

Go to **Azure Portal** ‚Üí **Log stream**

You should see:
```
‚úÖ JWT Service initialized from environment variables
‚úÖ JWT private key validated as RSA key
‚úÖ JWT Service initialized successfully
üöÄ Server running on port...
```

### Step 9: Test OAuth Login

Try logging in with Google OAuth. It should work now!

## Common Mistakes

### ‚ùå Don't Do This:
- Copying only part of the key
- Adding quotes around the key
- Adding extra spaces or line breaks
- Using `SESSION_SECRET` instead of RSA keys
- Using a password string

### ‚úÖ Do This:
- Copy the **ENTIRE** key (all lines)
- Include `-----BEGIN` and `-----END` markers
- Paste exactly as shown
- Use RSA keys generated by the script

## Verification Checklist

After setting keys, verify:

- [ ] Keys are set in Azure Portal
- [ ] Private key is 1600+ characters
- [ ] Private key starts with `-----BEGIN PRIVATE KEY-----`
- [ ] Private key ends with `-----END PRIVATE KEY-----`
- [ ] Public key starts with `-----BEGIN PUBLIC KEY-----`
- [ ] Public key ends with `-----END PUBLIC KEY-----`
- [ ] App service was restarted
- [ ] Logs show "JWT Service initialized successfully"
- [ ] Diagnostic script shows keys are valid

## If Still Not Working

1. **Run diagnostic**: `node scripts/check-jwt-keys-azure.js` in Kudu
2. **Check the error message** - it will tell you exactly what's wrong
3. **Regenerate keys** if needed
4. **Verify you clicked Save** in Azure Portal
5. **Manually restart** the app service if needed

## What Changed

The app will now:
- ‚úÖ Start successfully even if JWT keys are invalid
- ‚úÖ Show clear error messages when OAuth is attempted
- ‚úÖ Guide you to fix the issue
- ‚úÖ Validate keys at initialization and usage time

This means your app won't crash, but OAuth won't work until keys are properly configured.

