# Fix JWT Keys Error - Step by Step Guide

## Current Error
```
Error: secretOrPrivateKey must be an asymmetric key when using RS256
```

This means `JWT_PRIVATE_KEY` is set in Azure but it's **NOT a valid RSA private key**.

## Step-by-Step Solution

### Step 1: Access Azure Kudu Console

1. Go to **Azure Portal** → **Your App Service**
2. Click **Advanced Tools** → Click **Go** (opens Kudu in new tab)
3. Click **Debug console** → **CMD**

### Step 2: Navigate to Backend Directory

In the Kudu console, type:
```bash
cd site\wwwroot\backend
```

### Step 3: Run Diagnostic Script

Check what's currently set:
```bash
node scripts/check-jwt-keys-azure.js
```

This will show you:
- Whether keys are set
- If they're valid RSA keys
- What's wrong with them

### Step 4: Generate New Keys

Generate fresh RSA keys:
```bash
node scripts/generate-keys.js
```

This creates:
- `config/keys/private.pem`
- `config/keys/public.pem`

### Step 5: Read the Private Key

Display the private key:
```bash
type config\keys\private.pem
```

**IMPORTANT:** Copy the ENTIRE output including:
- `-----BEGIN PRIVATE KEY-----`
- All the base64 content (multiple lines)
- `-----END PRIVATE KEY-----`

### Step 6: Read the Public Key

Display the public key:
```bash
type config\keys\public.pem
```

Copy the ENTIRE output including:
- `-----BEGIN PUBLIC KEY-----`
- All the base64 content
- `-----END PUBLIC KEY-----`

### Step 7: Update Azure Portal

1. Go to **Azure Portal** → **Your App Service** → **Configuration** → **Application settings**

2. **Find `JWT_PRIVATE_KEY`** (if it exists, click Edit; if not, click + New application setting)
   - **Name**: `JWT_PRIVATE_KEY`
   - **Value**: Paste the ENTIRE private key you copied (all lines)
   - Click **OK**

3. **Find `JWT_PUBLIC_KEY`** (if it exists, click Edit; if not, click + New application setting)
   - **Name**: `JWT_PUBLIC_KEY`
   - **Value**: Paste the ENTIRE public key you copied (all lines)
   - Click **OK**

4. **Click "Save"** at the top of the page

5. **Wait for the app to restart** (about 1-2 minutes)

### Step 8: Verify

Check the logs - you should see:
```
✅ JWT Service initialized from environment variables
✅ JWT private key validated as RSA key
✅ JWT Service initialized successfully
```

If you still see errors, run the diagnostic again:
```bash
node scripts/check-jwt-keys-azure.js
```

## Common Mistakes to Avoid

### ❌ Don't Do This:
- Copying only part of the key
- Adding quotes around the key
- Adding extra spaces
- Using a symmetric secret (like SESSION_SECRET)
- Using a password string

### ✅ Do This:
- Copy the ENTIRE key (all lines)
- Include BEGIN and END markers
- Paste exactly as shown
- Use RSA keys generated by the script

## Quick Verification

After setting keys, the diagnostic script should show:
```
✅ JWT_PRIVATE_KEY is VALID!
✅ JWT_PUBLIC_KEY is VALID!
✅ JWT keys are properly configured!
```

## Still Not Working?

1. **Run diagnostic**: `node scripts/check-jwt-keys-azure.js`
2. **Check the error message** - it will tell you exactly what's wrong
3. **Regenerate keys** if needed
4. **Make sure you clicked Save** in Azure Portal
5. **Restart the app service** if it didn't restart automatically

## Alternative: Use Local Keys

If you prefer to generate keys locally:

1. On your local machine:
   ```bash
   cd backend
   node scripts/generate-keys.js
   ```

2. Read the keys:
   ```powershell
   Get-Content config/keys/private.pem -Raw
   Get-Content config/keys/public.pem -Raw
   ```

3. Copy to Azure Portal as described in Step 7

The key is to ensure the keys are **valid RSA keys** and **copied completely** to Azure Portal.

