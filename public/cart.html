<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | TradingPro</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .cart-container { min-height: 100vh; padding-top: 100px; padding-bottom: 60px; }
        .cart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-2xl); margin-top: var(--spacing-2xl); }
        .cart-items { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .cart-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-lg); display: grid; grid-template-columns: 1fr auto; gap: var(--spacing-lg); align-items: center; }
        .item-info h3 { font-size: var(--font-size-xl); margin-bottom: var(--spacing-sm); }
        .item-details { display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-sm); color: var(--text-secondary); font-size: var(--font-size-sm); }
        .item-dates { color: var(--text-tertiary); font-size: var(--font-size-sm); }
        .item-actions { display: flex; flex-direction: column; gap: var(--spacing-sm); align-items: flex-end; }
        .item-price { font-size: var(--font-size-2xl); font-weight: 700; color: var(--primary-color); margin-bottom: var(--spacing-sm); }
        .cart-summary { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-xl); height: fit-content; position: sticky; top: 100px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color); }
        .summary-row:last-child { border-bottom: none; }
        .summary-total { font-size: var(--font-size-xl); font-weight: 700; }
        .empty-cart { text-align: center; padding: var(--spacing-3xl); }
        .empty-cart-icon { font-size: 80px; margin-bottom: var(--spacing-lg); }
        .btn-group { display: flex; gap: var(--spacing-sm); }
        @media (max-width: 1024px) { .cart-grid { grid-template-columns: 1fr; } .cart-summary { position: static; } }
    </style>
    <!-- API Configuration - Auto-detects environment -->
    <script src="js/config.js"></script>
</head>
<body>
    <header class="header" id="header">
        <nav class="nav container">
            <a href="dashboard.html" class="nav__logo">
                <span class="logo__icon">üìà</span>
                <span class="logo__text">TradingPro</span>
            </a>
            <div class="nav__actions">
                <a href="products.html" class="btn btn--secondary">Continue Shopping</a>
                <a href="dashboard.html" class="btn btn--secondary">Dashboard</a>
                <button id="logout-btn" class="btn btn--outline">Logout</button>
            </div>
        </nav>
    </header>

    <main class="cart-container">
        <div class="container">
            <div class="section__header">
                <h1 class="section__title">Shopping Cart</h1>
                <p class="section__description">Review your items before checkout</p>
            </div>

            <div id="cart-content">
                <div class="loading" style="text-align: center; padding: 60px;">Loading cart...</div>
            </div>
        </div>
    </main>

    <script>
        // API_BASE_URL is set by config.js (auto-detects environment)
        let cartData = null;

        // Get JWT token from localStorage
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Get authorization headers
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return headers;
        }

        // Check authentication on page load
        async function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return false;
                    }
                    throw new Error('Failed to verify authentication');
                }

                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.removeItem('authToken');
                window.location.href = 'login.html';
                return false;
            }
        }

        async function loadCart() {
            try {
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to load cart');
                }
                
                cartData = await response.json();
                displayCart();
            } catch (error) {
                console.error('Error loading cart:', error);
                document.getElementById('cart-content').innerHTML = `<p class="error">Failed to load cart: ${error.message}</p>`;
            }
        }

        function displayCart() {
            const container = document.getElementById('cart-content');
            
            if (!cartData.items || cartData.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">üõí</div>
                        <h2>Your cart is empty</h2>
                        <p>Add some products to get started</p>
                        <a href="products.html" class="btn btn--primary" style="margin-top: 20px;">Browse Products</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="cart-grid">
                    <div class="cart-items">
                        ${cartData.items.map(item => `
                            <div class="cart-item">
                                <div class="item-info">
                                    <h3>${item.product_name}</h3>
                                    <div class="item-details">
                                        <span>üìÖ ${item.duration_unit === 'MONTH' ? 'Monthly' : 'Yearly'}</span>
                                        <span>‚è±Ô∏è ${item.duration_value} ${item.duration_unit === 'MONTH' ? 'Month(s)' : 'Year(s)'}</span>
                                        <span>üí∞ ‚Çπ${(item.price / item.duration_value).toFixed(2)}/unit</span>
                                    </div>
                                    <div class="item-dates">
                                        Valid: ${formatDate(item.start_date)} - ${formatDate(item.end_date)}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <div class="item-price">‚Çπ${parseFloat(item.price).toFixed(2)}</div>
                                    <div class="btn-group">
                                        <button class="btn btn--secondary edit-item-btn" data-item-id="${item.id}">‚úèÔ∏è Edit</button>
                                        <button class="btn btn--outline remove-item-btn" data-item-id="${item.id}">üóëÔ∏è Remove</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="cart-summary">
                        <h2 style="margin-bottom: 20px;">Order Summary</h2>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>‚Çπ${cartData.summary.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount:</span>
                            <span>-‚Çπ${cartData.summary.discount.toFixed(2)}</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total:</span>
                            <span>‚Çπ${cartData.summary.total.toFixed(2)}</span>
                        </div>
                        <button class="btn btn--primary btn--full btn--large proceed-checkout-btn" style="margin-top: 20px;">
                            Proceed to Payment
                        </button>
                        <button class="btn btn--outline btn--full empty-cart-btn" style="margin-top: 10px;">
                            Empty Cart
                        </button>
                    </div>
                </div>
            `;
            
            // Attach event listeners to all buttons
            document.querySelectorAll('.edit-item-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = parseInt(this.getAttribute('data-item-id'));
                    editItem(itemId);
                });
            });
            
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = parseInt(this.getAttribute('data-item-id'));
                    removeItem(itemId);
                });
            });
            
            const proceedCheckoutBtn = document.querySelector('.proceed-checkout-btn');
            if (proceedCheckoutBtn) {
                proceedCheckoutBtn.addEventListener('click', proceedToCheckout);
            }
            
            const emptyCartBtn = document.querySelector('.empty-cart-btn');
            if (emptyCartBtn) {
                emptyCartBtn.addEventListener('click', emptyCart);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        async function removeItem(itemId) {
            if (!confirm('Remove this item from cart?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/cart/items/${itemId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to remove item');
                }
                
                await loadCart();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function emptyCart() {
            if (!confirm('Remove all items from cart?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to empty cart');
                }
                
                await loadCart();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function editItem(itemId) {
            const item = cartData.items.find(i => i.id === itemId);
            if (!item) return;

            // Create a modal for editing
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999';
            modal.innerHTML = `
                <div style="background:var(--card-bg);padding:30px;border-radius:12px;max-width:400px;width:90%">
                    <h3 style="margin-bottom:20px">Edit Cart Item</h3>
                    <p style="margin-bottom:15px"><strong>${item.product_name}</strong></p>
                    <div style="margin-bottom:15px">
                        <label style="display:block;margin-bottom:5px">Duration Type:</label>
                        <select id="edit-duration-type" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary)">
                            <option value="MONTH" ${item.duration_unit === 'MONTH' ? 'selected' : ''}>Monthly</option>
                            <option value="YEAR" ${item.duration_unit === 'YEAR' ? 'selected' : ''}>Yearly</option>
                        </select>
                    </div>
                    <div style="margin-bottom:20px">
                        <label style="display:block;margin-bottom:5px">Duration (1-12):</label>
                        <input type="number" id="edit-duration-value" min="1" max="12" value="${item.duration_value}" style="width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary)">
                    </div>
                    <div style="display:flex;gap:10px">
                        <button class="btn btn--primary update-cart-item-btn" data-item-id="${itemId}" style="flex:1">Update</button>
                        <button class="btn btn--outline close-edit-modal-btn" style="flex:1">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentEditModal = modal;
            
            // Attach event listeners to modal buttons
            const updateBtn = modal.querySelector('.update-cart-item-btn');
            const closeBtn = modal.querySelector('.close-edit-modal-btn');
            
            if (updateBtn) {
                updateBtn.addEventListener('click', async () => {
                    await updateCartItem(itemId);
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', closeEditModal);
            }
        }

        function closeEditModal() {
            if (window.currentEditModal) {
                document.body.removeChild(window.currentEditModal);
                window.currentEditModal = null;
            }
        }

        async function updateCartItem(itemId) {
            const durationType = document.getElementById('edit-duration-type').value;
            const durationValue = parseInt(document.getElementById('edit-duration-value').value);

            if (isNaN(durationValue) || durationValue < 1 || durationValue > 12) {
                alert('Please enter a valid duration between 1 and 12');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/cart/items/${itemId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        duration_value: durationValue,
                        duration_unit: durationType
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update item');
                }
                
                closeEditModal();
                await loadCart();
                alert('Cart item updated successfully!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function proceedToCheckout() {
            if (!cartData.items || cartData.items.length === 0) {
                alert('Your cart is empty');
                return;
            }
            
            window.location.href = 'checkout.html';
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        });

        // Initialize page
        (async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadCart();
            }
        })();
    </script>
</body>
</html>

