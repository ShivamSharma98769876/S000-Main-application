<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Insights | Admin Panel</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .insights-container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .insights-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .insights-grid { display: grid; gap: 1.5rem; }
        .insight-card { background: var(--card-bg); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); }
        .insight-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .insight-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
        .insight-meta { font-size: 0.875rem; color: var(--text-secondary); }
        .insight-content { color: var(--text-secondary); margin: 1rem 0; max-height: 100px; overflow: hidden; text-overflow: ellipsis; }
        .insight-actions { display: flex; gap: 0.5rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500; }
        .status-badge.published { background: var(--success-bg); color: var(--success-color); }
        .status-badge.draft { background: var(--warning-bg); color: var(--warning-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); overflow-y: auto; }
        .modal-content { background: var(--card-bg); margin: 2% auto; padding: 2rem; border-radius: var(--radius-xl); max-width: 900px; position: relative; }
        .modal-close { position: absolute; right: 1.5rem; top: 1.5rem; font-size: 2rem; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .modal-close:hover { color: var(--text-primary); }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
        .form-input, .form-textarea { width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit; }
        .form-textarea { min-height: 400px; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6; }
        .form-actions { display: flex; gap: 1rem; justify-content: flex-end; }
    </style>
    <!-- API Configuration - Auto-detects environment -->
    <script src="../js/config.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav container">
            <a href="dashboard.html" class="nav__logo">
                <span class="logo__icon">üìà</span>
                <span class="logo__text">StockSage Admin</span>
            </a>
            <div class="nav__actions">
                <a href="dashboard.html" class="btn btn--secondary">Dashboard</a>
                <a href="products.html" class="btn btn--secondary">Products</a>
                <a href="orders.html" class="btn btn--secondary">Orders</a>
                <button id="logout-btn" class="btn btn--outline">Logout</button>
            </div>
        </nav>
    </header>

    <main class="main" style="padding-top: 100px;">
        <div class="insights-container">
            <div class="insights-header">
                <div>
                    <h1 class="section__title">Market Insights</h1>
                    <p class="section__description">Manage real-time market analysis and reports</p>
                </div>
                <button class="btn btn--primary" onclick="openCreateModal()">
                    ‚ûï Create New Insight
                </button>
            </div>

            <div id="insights-list" class="insights-grid">
                <p style="text-align: center; color: var(--text-secondary);">Loading insights...</p>
            </div>
        </div>
    </main>

    <!-- Format Guide Modal -->
    <div id="format-guide-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="document.getElementById('format-guide-modal').style.display='none'">&times;</span>
            <h2>HTML Formatting Guide</h2>
            
            <div style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 0.5rem;">Headings</h3>
                <code>&lt;h2&gt;Main Section&lt;/h2&gt;</code><br>
                <code>&lt;h3&gt;Subsection&lt;/h3&gt;</code><br>
                <code>&lt;h4&gt;Minor Heading&lt;/h4&gt;</code>

                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Text Formatting</h3>
                <code>&lt;p&gt;Regular paragraph&lt;/p&gt;</code><br>
                <code>&lt;strong&gt;Bold text&lt;/strong&gt;</code><br>
                <code>&lt;em&gt;Italic text&lt;/em&gt;</code><br>
                <code>&lt;br&gt;</code> - Line break

                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Lists</h3>
                <pre style="background: var(--bg-tertiary); padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>&lt;ul&gt;
  &lt;li&gt;Bullet point 1&lt;/li&gt;
  &lt;li&gt;Bullet point 2&lt;/li&gt;
&lt;/ul&gt;</code></pre>

                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Table Example</h3>
                <pre style="background: var(--bg-tertiary); padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Move&lt;/th&gt;
      &lt;th&gt;Probability&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Upside&lt;/td&gt;
      &lt;td&gt;45%&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;</code></pre>

                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Other Elements</h3>
                <code>&lt;blockquote&gt;Important quote&lt;/blockquote&gt;</code><br>
                <code>&lt;hr&gt;</code> - Horizontal line<br>
                <code>&lt;a href="url"&gt;Link text&lt;/a&gt;</code>
            </div>

            <button class="btn btn--primary btn--full" onclick="document.getElementById('format-guide-modal').style.display='none'" style="margin-top: 1.5rem;">
                Got it!
            </button>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="insight-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Create Market Insight</h2>
            <form id="insight-form">
                <input type="hidden" id="insight-id">
                
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="insight-title" class="form-input" required 
                           placeholder="e.g., Intraday Nifty 50 Report: December 24, 2025">
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="insight-category" class="form-input">
                        <option value="intraday">Intraday</option>
                        <option value="weekly">Weekly</option>
                        <option value="special">Special Report</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Content * (supports HTML formatting)</label>
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <p style="font-size: 0.875rem; color: var(--text-secondary);">
                            ‚úÖ Supported: &lt;h1&gt; to &lt;h4&gt;, &lt;p&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;, &lt;br&gt;, &lt;table&gt;, &lt;blockquote&gt;, &lt;code&gt;, &lt;pre&gt;, &lt;a&gt;, &lt;hr&gt;
                            <br>‚ùå Blocked: &lt;script&gt;, &lt;iframe&gt;, onclick, javascript:
                        </p>
                        <button type="button" class="btn btn--secondary" onclick="showFormatGuide()" style="margin-left: 1rem;">
                            üìù Format Guide
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Editor</label>
                            <textarea id="insight-content" class="form-textarea" required 
                                      placeholder="Enter HTML or plain text here..." 
                                      style="min-height: 400px; font-family: 'Courier New', monospace;"></textarea>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Live Preview</label>
                            <div id="content-preview" style="min-height: 400px; padding: 1rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow-y: auto; line-height: 1.6; color: var(--text-secondary);">
                                <em style="color: var(--text-secondary);">Preview will appear here...</em>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="insight-status" class="form-input">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn--primary">Save Insight</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API_BASE_URL is set by config.js (auto-detects environment)

        // Get JWT token from localStorage
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Get authorization headers
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return headers;
        }

        async function checkAdminAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '../login.html';
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = '../login.html';
                        return false;
                    }
                    throw new Error('Not authenticated');
                }
                
                const data = await response.json();
                if (!data.user || !data.user.is_admin) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '../dashboard.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Admin auth check error:', error);
                localStorage.removeItem('authToken');
                window.location.href = '../login.html';
                return false;
            }
        }

        async function loadInsights() {
            try {
                const response = await fetch(`${API_BASE_URL}/insights/admin/all`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to load insights');

                const data = await response.json();
                displayInsights(data.insights);
            } catch (error) {
                console.error('Error loading insights:', error);
                document.getElementById('insights-list').innerHTML = 
                    '<p style="text-align: center; color: var(--error-color);">Failed to load insights</p>';
            }
        }

        function displayInsights(insights) {
            const container = document.getElementById('insights-list');

            if (insights.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No insights yet. Create your first one!</p>';
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-header">
                        <div>
                            <h3 class="insight-title">${insight.title}</h3>
                            <div class="insight-meta">
                                <span class="status-badge ${insight.status}">${insight.status.toUpperCase()}</span>
                                ${insight.category ? `<span> ‚Ä¢ ${insight.category}</span>` : ''}
                                ${insight.published_at ? `<span> ‚Ä¢ Published: ${new Date(insight.published_at).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                        <div class="insight-actions">
                            <button class="btn btn--secondary edit-insight-btn" data-insight-id="${insight.id}">Edit</button>
                            <button class="btn btn--outline delete-insight-btn" data-insight-id="${insight.id}">Delete</button>
                        </div>
                    </div>
                    <div class="insight-content">${insight.content.substring(0, 200)}...</div>
                </div>
            `).join('');
            
            // Attach event listeners to action buttons
            document.querySelectorAll('.edit-insight-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const insightId = parseInt(this.getAttribute('data-insight-id'));
                    editInsight(insightId);
                });
            });
            
            document.querySelectorAll('.delete-insight-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const insightId = parseInt(this.getAttribute('data-insight-id'));
                    deleteInsight(insightId);
                });
            });
        }

        function openCreateModal() {
            document.getElementById('modal-title').textContent = 'Create Market Insight';
            document.getElementById('insight-form').reset();
            document.getElementById('insight-id').value = '';
            document.getElementById('insight-modal').style.display = 'block';
        }

        async function editInsight(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/insights/admin/all`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const insight = data.insights.find(i => i.id === id);

                if (insight) {
                    document.getElementById('modal-title').textContent = 'Edit Market Insight';
                    document.getElementById('insight-id').value = insight.id;
                    document.getElementById('insight-title').value = insight.title;
                    document.getElementById('insight-content').value = insight.content;
                    document.getElementById('insight-category').value = insight.category;
                    document.getElementById('insight-status').value = insight.status;
                    
                    // Trigger preview update
                    document.getElementById('content-preview').innerHTML = insight.content;
                    
                    document.getElementById('insight-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading insight:', error);
                alert('Failed to load insight');
            }
        }

        async function deleteInsight(id) {
            if (!confirm('Are you sure you want to delete this insight?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/insights/admin/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to delete insight');

                alert('Insight deleted successfully');
                loadInsights();
            } catch (error) {
                console.error('Error deleting insight:', error);
                alert('Failed to delete insight');
            }
        }

        function closeModal() {
            document.getElementById('insight-modal').style.display = 'none';
        }

        document.getElementById('insight-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('insight-id').value;
            const data = {
                title: document.getElementById('insight-title').value,
                content: document.getElementById('insight-content').value,
                category: document.getElementById('insight-category').value,
                status: document.getElementById('insight-status').value
            };

            try {
                const url = id 
                    ? `${API_BASE_URL}/insights/admin/${id}`
                    : `${API_BASE_URL}/insights/admin`;
                
                const response = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save insight');

                alert('Insight saved successfully!');
                closeModal();
                loadInsights();
            } catch (error) {
                console.error('Error saving insight:', error);
                alert('Failed to save insight');
            }
        });

        // Close modal on outside click
        window.onclick = function(event) {
            const insightModal = document.getElementById('insight-modal');
            const formatGuideModal = document.getElementById('format-guide-modal');
            
            if (event.target === insightModal) {
                closeModal();
            }
            if (event.target === formatGuideModal) {
                formatGuideModal.style.display = 'none';
            }
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            localStorage.removeItem('authToken');
            window.location.href = '../login.html';
        });

        // Check auth and load insights on page load
        checkAdminAuth().then(isAdmin => {
            if (isAdmin) {
                loadInsights();
            }
        });

        // Show HTML formatting guide
        function showFormatGuide() {
            document.getElementById('format-guide-modal').style.display = 'block';
        }

        // Live preview functionality
        document.getElementById('insight-content').addEventListener('input', function() {
            const preview = document.getElementById('content-preview');
            const content = this.value;
            
            if (content.trim()) {
                preview.innerHTML = content;
            } else {
                preview.innerHTML = '<em style="color: var(--text-secondary);">Preview will appear here...</em>';
            }
        });

        // Load insights on page load
        loadInsights();
    </script>
    
    <style>
        /* Preview pane styling - same as frontend */
        #content-preview h1, #content-preview h2, #content-preview h3, #content-preview h4 {
            color: var(--text-primary);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        #content-preview h1 { font-size: 1.75rem; }
        #content-preview h2 { font-size: 1.5rem; }
        #content-preview h3 { font-size: 1.25rem; }
        #content-preview h4 { font-size: 1.1rem; }
        #content-preview p { margin-bottom: 1rem; }
        #content-preview ul, #content-preview ol { 
            margin-left: 1.5rem; 
            margin-bottom: 1rem; 
        }
        #content-preview li { margin-bottom: 0.5rem; }
        #content-preview strong, #content-preview b { 
            color: var(--text-primary); 
            font-weight: 600; 
        }
        #content-preview em, #content-preview i { font-style: italic; }
        #content-preview code { 
            background: var(--bg-secondary); 
            padding: 0.2rem 0.4rem; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.9rem;
        }
        #content-preview pre {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        #content-preview table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        #content-preview th, #content-preview td {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        #content-preview th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
        }
        #content-preview blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
        }
        #content-preview hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 2rem 0;
        }
        #content-preview a {
            color: var(--primary-color);
            text-decoration: underline;
        }
    </style>
</body>
</html>

