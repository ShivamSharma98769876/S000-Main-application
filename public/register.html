<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Registration | StockSage</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/auth.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .form-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
        }
        .form-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            max-width: 600px;
            width: 100%;
        }
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
        }
        .form-label.required::after {
            content: ' *';
            color: var(--danger-color);
        }
        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            transition: border-color var(--transition-fast);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .form-input.error {
            border-color: var(--danger-color);
        }
        .form-error {
            color: var(--danger-color);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-xs);
        }
        .form-hint {
            color: var(--text-tertiary);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-xs);
        }
        .alert {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
        }
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
    </style>
    <!-- API Configuration - Auto-detects environment -->
    <script src="js/config.js"></script>
</head>
<body>
    <div class="form-container">
        <div class="form-card">
            <div class="auth-header">
                <a href="index.html" class="auth-logo">
                    <span class="logo__icon">üìà</span>
                    <span class="logo__text">StockSage</span>
                </a>
                <h1 class="auth-title">Complete Your Profile</h1>
                <p class="auth-subtitle">Please provide the following information to continue</p>
            </div>

            <div id="alert-container"></div>

            <form id="registration-form">
                <div class="form-group">
                    <label for="fullName" class="form-label required">Full Name</label>
                    <input type="text" id="fullName" name="fullName" class="form-input" required>
                    <div class="form-error" id="fullName-error"></div>
                </div>

                <div class="form-group">
                    <label for="address" class="form-label required">Address</label>
                    <textarea id="address" name="address" class="form-input" rows="3" required></textarea>
                    <div class="form-error" id="address-error"></div>
                </div>

                <div class="form-group">
                    <label for="phone" class="form-label required">Phone Number</label>
                    <input type="tel" id="phone" name="phone" class="form-input" placeholder="+91 98765 43210" required>
                    <div class="form-hint">Format: +91 XXXXX XXXXX</div>
                    <div class="form-error" id="phone-error"></div>
                </div>

                <div class="form-group">
                    <label for="capitalUsed" class="form-label required">Capital Used for Trading (‚Çπ)</label>
                    <input type="number" id="capitalUsed" name="capitalUsed" class="form-input" min="0" step="1000" required>
                    <div class="form-hint">Enter the amount of capital you use for trading</div>
                    <div class="form-error" id="capitalUsed-error"></div>
                </div>

                <div class="form-group">
                    <label for="zerodhaClientId" class="form-label required">Zerodha Client ID</label>
                    <input type="text" id="zerodhaClientId" name="zerodhaClientId" class="form-input" required>
                    <div class="form-hint">Enter your Zerodha trading account client ID</div>
                    <div class="form-error" id="zerodhaClientId-error"></div>
                </div>

                <div class="form-group">
                    <label for="referralCode" class="form-label">Referral Code (Optional)</label>
                    <input type="text" id="referralCode" name="referralCode" class="form-input">
                    <div class="form-hint">Enter referral code if you have one</div>
                </div>

                <button type="submit" class="btn btn--primary btn--full btn--large" id="submit-btn">
                    Complete Registration
                </button>
            </form>
        </div>
    </div>

    <script>
        // API_BASE_URL is set by config.js (auto-detects environment)
        const form = document.getElementById('registration-form');
        const submitBtn = document.getElementById('submit-btn');
        const alertContainer = document.getElementById('alert-container');

        // Get JWT token from localStorage or URL
        function getAuthToken() {
            // Check URL for JWT token (from OAuth redirect)
            // Support both 'jwt' (new) and 'token' (legacy) parameter names
            const urlParams = new URLSearchParams(window.location.search);
            const jwtTokenFromUrl = urlParams.get('jwt') || urlParams.get('token'); // Support both for backward compatibility
            
            if (jwtTokenFromUrl) {
                console.log('=== JWT TOKEN FOUND IN URL ===');
                console.log('JWT Token length:', jwtTokenFromUrl.length);
                console.log('JWT Token preview:', jwtTokenFromUrl.substring(0, 50) + '...');
                
                // Store JWT token in localStorage (using 'authToken' key for backward compatibility)
                localStorage.setItem('authToken', jwtTokenFromUrl);
                console.log('JWT Token stored in localStorage');
                
                // Remove JWT token from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                console.log('JWT Token removed from URL');
                
                return jwtTokenFromUrl;
            }
            
            // Get JWT token from localStorage
            const storedJwtToken = localStorage.getItem('authToken');
            if (storedJwtToken) {
                console.log('JWT Token retrieved from localStorage');
            } else {
                console.log('No JWT token found in URL or localStorage');
            }
            
            return storedJwtToken;
        }

        // Get authorization headers with JWT token
        function getAuthHeaders() {
            const jwtToken = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (jwtToken) {
                headers['Authorization'] = `Bearer ${jwtToken}`;
            }
            
            return headers;
        }

        // Show error message on page
        function showError(message, details = null) {
            // Remove any existing error messages
            const existingError = document.getElementById('auth-error-message');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'auth-error-message';
            errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; background: #fee; color: #c33; padding: 20px; border-radius: 8px; border: 2px solid #fcc; max-width: 600px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-family: system-ui, -apple-system, sans-serif;';
            
            errorDiv.innerHTML = `
                <h3 style="margin: 0 0 10px 0; color: #c33;">‚ö†Ô∏è Authentication Error</h3>
                <p style="margin: 0 0 10px 0;"><strong>${message}</strong></p>
                ${details ? `<pre style="background: #fff; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; font-size: 12px; margin: 10px 0;">${JSON.stringify(details, null, 2)}</pre>` : ''}
                <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">Redirecting to login page...</p>
            `;
            
            // Ensure document.body exists before appending
            if (document.body) {
                document.body.appendChild(errorDiv);
            } else {
                // If body doesn't exist yet, wait for DOM to load
                document.addEventListener('DOMContentLoaded', () => {
                    document.body.appendChild(errorDiv);
                });
            }
        }

        // Check if user is authenticated with JWT token
        async function checkAuth() {
            console.log('=== CHECKING AUTHENTICATION ===');
            const jwtToken = getAuthToken();
            console.log('JWT Token available:', !!jwtToken);
            
            if (!jwtToken) {
                console.error('‚ùå No JWT token found');
                showError('No JWT token found in URL or localStorage. Please log in again.', {
                    url: window.location.href,
                    hasTokenInUrl: window.location.search.includes('jwt') || window.location.search.includes('token'),
                    localStorageHasToken: !!localStorage.getItem('authToken')
                });
                
                console.log('Redirecting to login page');
                window.location.href = 'login.html';
                return;
            }

            try {
                console.log('Fetching user data from /auth/me with JWT token');
                console.log('API Base URL:', API_BASE_URL);
                console.log('Request URL:', `${API_BASE_URL}/auth/me`);
                
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                console.log('Auth response status:', response.status);
                console.log('Auth response ok:', response.ok);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    let errorData = {};
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { message: await response.text() };
                    }
                    
                    console.error('‚ùå Auth check failed:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData,
                        responseHeaders: Object.fromEntries(response.headers.entries())
                    });
                    
                    if (response.status === 401) {
                        const errorMessage = errorData.message || 'JWT token invalid or expired';
                        console.error('‚ùå 401 Unauthorized:', errorMessage);
                        showError(errorMessage, {
                            status: response.status,
                            statusText: response.statusText,
                            error: errorData,
                            jwtTokenLength: jwtToken.length,
                            jwtTokenPreview: jwtToken.substring(0, 50) + '...'
                        });
                        
                        localStorage.removeItem('authToken');
                        
                        console.log('Redirecting to login page');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    showError(`Authentication failed: ${response.status} ${response.statusText}`, {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    
                    console.log('Redirecting to login page');
                    window.location.href = 'login.html';
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Auth successful:', {
                    userId: data.user?.id,
                    email: data.user?.email,
                    profileCompleted: data.profile?.profile_completed,
                    isProfileComplete: data.isProfileComplete,
                    hasProfile: !!data.profile,
                    fullResponse: data
                });
                
                // If profile is already complete, redirect to dashboard
                // Check both property names for compatibility
                if (data.isProfileComplete === true || data.profileCompleted === true) {
                    console.log('Profile already complete, redirecting to dashboard');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                console.log('‚úÖ Profile incomplete, staying on registration page');
            } catch (error) {
                console.error('‚ùå Auth check exception:', error);
                console.error('Error stack:', error.stack);
                showError('Authentication check failed with exception', {
                    error: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                localStorage.removeItem('authToken');
                
                console.log('Redirecting to login page');
                window.location.href = 'login.html';
            }
        }

        // Show alert
        function showAlert(message, type = 'error') {
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
        }

        // Clear field error
        function clearError(fieldName) {
            const input = document.getElementById(fieldName);
            const error = document.getElementById(`${fieldName}-error`);
            input.classList.remove('error');
            error.textContent = '';
        }

        // Show field error
        function showError(fieldName, message) {
            const input = document.getElementById(fieldName);
            const error = document.getElementById(`${fieldName}-error`);
            input.classList.add('error');
            error.textContent = message;
        }

        // Clear all errors
        function clearAllErrors() {
            const inputs = form.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.classList.remove('error');
            });
            const errors = form.querySelectorAll('.form-error');
            errors.forEach(error => {
                error.textContent = '';
            });
        }

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            clearAllErrors();
            alertContainer.innerHTML = '';
            
            const formData = {
                fullName: document.getElementById('fullName').value.trim(),
                address: document.getElementById('address').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                capitalUsed: parseFloat(document.getElementById('capitalUsed').value),
                zerodhaClientId: document.getElementById('zerodhaClientId').value.trim(),
                referralCode: document.getElementById('referralCode').value.trim() || undefined
            };
            
            // Client-side validation
            let hasError = false;
            
            if (formData.fullName.length < 2) {
                showError('fullName', 'Full name must be at least 2 characters');
                hasError = true;
            }
            
            if (formData.address.length < 5) {
                showError('address', 'Address must be at least 5 characters');
                hasError = true;
            }
            
            // Phone number format validation removed - any format is accepted
            
            if (formData.capitalUsed < 0) {
                showError('capitalUsed', 'Capital must be a positive number');
                hasError = true;
            }
            
            if (formData.zerodhaClientId.length < 2) {
                showError('zerodhaClientId', 'Zerodha Client ID must be at least 2 characters');
                hasError = true;
            }
            
            if (hasError) {
                return;
            }
            
            // Submit to API
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/me/profile`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Show detailed validation errors
                    if (data.details && Array.isArray(data.details)) {
                        let errorMessages = data.details.map(err => `${err.path}: ${err.msg}`).join('<br>');
                        showAlert(errorMessages, 'error');
                    } else {
                        showAlert(data.message || 'Failed to submit profile', 'error');
                    }
                    throw new Error(data.message || 'Failed to submit profile');
                }
                
                showAlert('Profile completed successfully! Redirecting...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                
            } catch (error) {
                console.error('Registration error:', error);
                showAlert(error.message || 'Failed to complete registration. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Complete Registration';
            }
        });

        // Clear errors on input
        form.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('input', () => {
                clearError(input.id);
            });
        });

        // Check authentication on load
        checkAuth();
    </script>
</body>
</html>

