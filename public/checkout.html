<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | StockSage</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .checkout-container { min-height: 100vh; padding-top: 100px; padding-bottom: 60px; }
        .checkout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-3xl); margin-top: var(--spacing-2xl); }
        .checkout-section { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-xl); padding: var(--spacing-2xl); }
        .section-title { font-size: var(--font-size-2xl); font-weight: 700; margin-bottom: var(--spacing-lg); }
        .payment-steps { display: flex; flex-direction: column; gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl); }
        .step { display: flex; align-items: start; gap: var(--spacing-md); }
        .step-number { width: 32px; height: 32px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
        .qr-container { text-align: center; padding: var(--spacing-2xl); background: white; border-radius: var(--radius-lg); margin: var(--spacing-xl) 0; }
        .qr-code { width: 250px; height: 250px; margin: 0 auto; }
        .upi-details { background: var(--bg-tertiary); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-top: var(--spacing-md); }
        .order-item { border-bottom: 1px solid var(--border-color); padding: var(--spacing-md) 0; }
        .order-item:last-child { border-bottom: none; }
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; margin-bottom: var(--spacing-sm); font-weight: 600; }
        .form-input { width: 100%; padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); }
        .datetime-input-wrapper { position: relative; }
        .datetime-input-wrapper input[type="datetime-local"] { 
            width: 100%; 
            padding: var(--spacing-md) 45px var(--spacing-md) var(--spacing-md); 
            background: var(--bg-tertiary); 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md); 
            color: var(--text-primary);
            font-size: var(--font-size-base);
            cursor: pointer;
        }
        .datetime-input-wrapper input[type="datetime-local"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .datetime-input-wrapper::after {
            content: 'üìÖ';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 18px;
        }
        .file-upload { border: 2px dashed var(--border-color); padding: var(--spacing-xl); text-align: center; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
        .file-upload:hover { border-color: var(--primary-color); background: rgba(59, 130, 246, 0.05); }
        .file-upload.has-file { border-color: var(--accent-color); background: rgba(16, 185, 129, 0.05); }
        @media (max-width: 1024px) { .checkout-grid { grid-template-columns: 1fr; } }
    </style>
    <!-- API Configuration - Auto-detects environment -->
    <script src="js/config.js"></script>
</head>
<body>
    <header class="header" id="header">
        <nav class="nav container">
            <a href="dashboard.html" class="nav__logo">
                <span class="logo__icon">üìà</span>
                <span class="logo__text">StockSage</span>
            </a>
            <div class="nav__actions">
                <a href="cart.html" class="btn btn--secondary">‚Üê Back to Cart</a>
            </div>
        </nav>
    </header>

    <main class="checkout-container">
        <div class="container">
            <div class="section__header">
                <h1 class="section__title">Payment</h1>
                <p class="section__description">Complete your payment to activate subscriptions</p>
            </div>

            <div class="checkout-grid">
                <!-- Payment Instructions -->
                <div class="checkout-section">
                    <h2 class="section-title">Payment Instructions</h2>
                    
                    <div class="payment-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div>
                                <h4>Scan QR Code</h4>
                                <p style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                    Use any UPI app to scan the QR code or use the UPI ID below
                                </p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div>
                                <h4>Make Payment</h4>
                                <p style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                    Enter the exact amount shown in your order summary
                                </p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div>
                                <h4>Upload Proof</h4>
                                <p style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                    Take a screenshot of the successful payment and upload below
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code -->
                    <div class="qr-container">
                        <h3 style="margin-bottom: 20px; color: #000;">Scan to Pay</h3>
                        <div class="qr-code" id="qr-code-container">
                            <!-- QR Code will be loaded dynamically -->
                            <div id="qr-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                                Loading QR code...
                            </div>
                            <img id="qr-code-image" src="" alt="Payment QR Code" style="display: none; width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        <div class="upi-details" id="upi-details">
                            <strong>UPI ID:</strong> <span id="upi-id">Loading...</span><br>
                            <strong>Merchant:</strong> <span id="merchant-name">Loading...</span>
                        </div>
                    </div>

                    <!-- Upload Form -->
                    <form id="payment-form">
                        <div class="form-group">
                            <label class="form-label">Payment Screenshot *</label>
                            <div class="file-upload" id="file-upload">
                                <div id="upload-text">
                                    üìé Click to upload screenshot<br>
                                    <small style="color: var(--text-tertiary);">JPG, PNG, or WEBP (Max 5MB)</small>
                                </div>
                                <input type="file" id="payment-proof" accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="payment-reference">Transaction Reference (Optional)</label>
                            <input type="text" id="payment-reference" class="form-input" placeholder="e.g., UTR123456789">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="payment-date">Payment Date & Time (Optional)</label>
                            <div class="datetime-input-wrapper">
                                <input type="datetime-local" id="payment-date" class="form-input" min="2020-01-01T00:00" max="2099-12-31T23:59">
                            </div>
                            <small style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-top: 5px; display: block;">
                                Click the calendar icon to select date and time
                            </small>
                        </div>

                        <button type="submit" class="btn btn--primary btn--full btn--large">
                            Submit Order with Payment Proof
                        </button>
                    </form>
                </div>

                <!-- Order Summary -->
                <div class="checkout-section">
                    <h2 class="section-title">Order Summary</h2>
                    <div id="order-summary">
                        <div class="loading">Loading order...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API_BASE_URL is set by config.js (auto-detects environment)
        let orderId = null;
        let selectedFile = null;

        // Get JWT token from localStorage
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Get authorization headers
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return headers;
        }

        // Get headers for file upload (without Content-Type, browser will set it with boundary)
        function getAuthHeadersForUpload() {
            const token = getAuthToken();
            const headers = {};
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return headers;
        }

        // Check authentication on page load
        async function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return false;
                    }
                    throw new Error('Failed to verify authentication');
                }

                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.removeItem('authToken');
                window.location.href = 'login.html';
                return false;
            }
        }

        // File upload handling
        const paymentProofInput = document.getElementById('payment-proof');
        const fileUploadDiv = document.getElementById('file-upload');
        
        if (paymentProofInput) {
            paymentProofInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    if (fileUploadDiv) {
                        fileUploadDiv.classList.add('has-file');
                        const uploadText = document.getElementById('upload-text');
                        if (uploadText) {
                            uploadText.innerHTML = `
                                ‚úÖ ${file.name}<br>
                                <small style="color: var(--accent-color);">File selected (${(file.size / 1024).toFixed(0)} KB)</small>
                            `;
                        }
                    }
                }
            });
        }
        
        // Fix inline onclick handler for file upload (CSP compliant)
        if (fileUploadDiv && paymentProofInput) {
            fileUploadDiv.addEventListener('click', () => {
                paymentProofInput.click();
            });
        }

        // Order creation is now handled by payment form submission
        // This function is no longer used but kept for backward compatibility
        async function createOrder() {
            // Order creation now requires payment proof
            // This is handled by the payment form submission
            console.warn('createOrder() called but order creation now requires payment proof. Use payment form instead.');
        }

        async function loadOrderSummary() {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/me/${orderId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to load order');
                }
                
                const data = await response.json();
                displayOrderSummary(data);
            } catch (error) {
                console.error('Error loading order:', error);
                document.getElementById('order-summary').innerHTML = `<p class="error">Failed to load order: ${error.message}</p>`;
            }
        }

        function displayOrderSummary(data) {
            const summary = document.getElementById('order-summary');
            summary.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Order ID:</strong> #${data.order.id}</p>
                    <p><strong>Status:</strong> <span style="color: var(--accent-color);">${data.order.status}</span></p>
                    <p><strong>Date:</strong> ${new Date(data.order.created_at).toLocaleString()}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Items:</h4>
                    ${data.items.map(item => `
                        <div class="order-item">
                            <strong>${item.product_name}</strong><br>
                            <small style="color: var(--text-secondary);">
                                ${item.duration_units} ${item.duration_type === 'MONTH' ? 'Month(s)' : 'Year(s)'} | 
                                ${new Date(item.start_date).toLocaleDateString()} - ${new Date(item.end_date).toLocaleDateString()}
                            </small>
                            <div style="text-align: right; margin-top: 5px;">‚Çπ${item.subtotal}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Subtotal:</span>
                        <span>‚Çπ${data.order.total_amount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xl); font-weight: 700; color: var(--primary-color);">
                        <span>Total Payable:</span>
                        <span>‚Çπ${data.order.total_amount}</span>
                    </div>
                </div>
            `;
        }

        // Handle form submission - Create order with payment proof
        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Payment proof is REQUIRED
            if (!selectedFile) {
                alert('Please upload a payment screenshot before submitting your order.');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Order...';
            
            try {
                // Create order with payment proof in one request
                const formData = new FormData();
                formData.append('paymentProof', selectedFile);
                formData.append('paymentReference', document.getElementById('payment-reference').value || '');
                formData.append('paymentDate', document.getElementById('payment-date').value || '');
                
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: getAuthHeadersForUpload(),
                    body: formData
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create order');
                }
                
                const data = await response.json();
                orderId = data.order.orderId;
                
                alert('Order created successfully! Your order is pending admin approval.');
                window.location.href = 'dashboard.html';
                
            } catch (error) {
                console.error('Error creating order:', error);
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Order';
            }
        });

        // Set default payment date/time to current date/time
        function setDefaultPaymentDateTime() {
            const paymentDateInput = document.getElementById('payment-date');
            if (paymentDateInput) {
                // Get current date/time in local timezone
                const now = new Date();
                // Format as YYYY-MM-DDTHH:mm for datetime-local input
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const defaultValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                paymentDateInput.value = defaultValue;
            }
        }

        // Load payment configuration
        async function loadPaymentConfig() {
            try {
                const response = await fetch(`${API_BASE_URL}/content/config`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load payment config');
                }
                
                const data = await response.json();
                const config = data.config || {};
                
                // Display QR code
                const qrCodeImage = document.getElementById('qr-code-image');
                const qrLoading = document.getElementById('qr-loading');
                const qrCodeContainer = document.getElementById('qr-code-container');
                
                if (config.qr_code_url) {
                    // Build full URL for QR code
                    const qrUrl = config.qr_code_url.startsWith('http') 
                        ? config.qr_code_url 
                        : `${API_BASE_URL.replace('/api/v1', '')}${config.qr_code_url}`;
                    
                    qrCodeImage.src = qrUrl;
                    qrCodeImage.style.display = 'block';
                    qrLoading.style.display = 'none';
                    qrCodeImage.onerror = () => {
                        qrLoading.textContent = 'QR code not available';
                        qrCodeImage.style.display = 'none';
                    };
                } else {
                    qrLoading.textContent = 'QR code not configured';
                }
                
                // Display UPI ID
                const upiIdElement = document.getElementById('upi-id');
                if (config.upi_id) {
                    upiIdElement.textContent = config.upi_id;
                } else {
                    upiIdElement.textContent = 'Not configured';
                    upiIdElement.style.color = 'var(--text-secondary)';
                }
                
                // Display Merchant Name
                const merchantNameElement = document.getElementById('merchant-name');
                if (config.merchant_name) {
                    merchantNameElement.textContent = config.merchant_name;
                } else {
                    merchantNameElement.textContent = 'StockSage India';
                    merchantNameElement.style.color = 'var(--text-secondary)';
                }
                
            } catch (error) {
                console.error('Error loading payment config:', error);
                // Show default/fallback values
                document.getElementById('upi-id').textContent = 'Not available';
                document.getElementById('merchant-name').textContent = 'StockSage India';
                document.getElementById('qr-loading').textContent = 'QR code not available';
            }
        }

        // Load cart summary instead of creating order
        async function loadCartSummary() {
            try {
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to load cart');
                }
                
                const data = await response.json();
                displayCartSummary(data);
            } catch (error) {
                console.error('Error loading cart:', error);
                document.getElementById('order-summary').innerHTML = `
                    <div style="color: var(--error-color);">
                        Error loading cart: ${error.message}
                    </div>
                `;
            }
        }

        function displayCartSummary(cartData) {
            const summary = document.getElementById('order-summary');
            
            if (!cartData.items || cartData.items.length === 0) {
                summary.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>Your cart is empty.</p>
                        <a href="cart.html" class="btn btn--primary" style="margin-top: 20px;">Go to Cart</a>
                    </div>
                `;
                return;
            }
            
            const totalAmount = cartData.items.reduce((sum, item) => sum + parseFloat(item.price || item.subtotal || 0), 0);
            
            summary.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Items in Cart:</strong> ${cartData.items.length}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Items:</h4>
                    ${cartData.items.map(item => `
                        <div class="order-item">
                            <strong>${item.product_name || 'Product'}</strong><br>
                            <small style="color: var(--text-secondary);">
                                ${item.duration_value || 0} ${(item.duration_unit || 'MONTH') === 'MONTH' ? 'Month(s)' : 'Year(s)'} | 
                                ${item.start_date ? new Date(item.start_date).toLocaleDateString() : 'N/A'} - ${item.end_date ? new Date(item.end_date).toLocaleDateString() : 'N/A'}
                            </small>
                            <div style="text-align: right; margin-top: 5px;">‚Çπ${parseFloat(item.price || item.subtotal || 0).toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xl); font-weight: 700; color: var(--primary-color);">
                        <span>Total Payable:</span>
                        <span>‚Çπ${totalAmount.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        // Initialize page
        (async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                setDefaultPaymentDateTime();
                loadPaymentConfig(); // Load payment configuration
                loadCartSummary(); // Load cart summary instead of creating order
            }
        })();
    </script>
</body>
</html>

