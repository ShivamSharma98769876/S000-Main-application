# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Node.js, GitHub Actions, and Azure App Service: https://aka.ms/nodejs-webapps-actions

name: Build and deploy Node.js app to Azure Web App - A000-Main-App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      # ðŸ› ï¸ Local Build Section (Optional)
      # The following section in your workflow is designed to catch build issues early on the client side, before deployment. This can be helpful for debugging and validation. However, if this step significantly increases deployment time and early detection is not critical for your workflow, you may remove this section to streamline the deployment process.
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          npm ci
                
      # By default, when you enable GitHub CI/CD integration through the Azure portal, the platform automatically sets the SCM_DO_BUILD_DURING_DEPLOYMENT application setting to true. This triggers the use of Oryx, a build engine that handles application compilation and dependency installation (e.g., npm install) directly on the platform during deployment. Hence, we exclude the node_modules directory from the deployment artifact to reduce the payload size. 
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: |
            backend/
            !backend/node_modules/
            !backend/logs/
            !backend/uploads/
            !backend/data/

      # ðŸš« Opting Out of Oryx Build
      # If you prefer to disable the Oryx build process during deployment, follow these steps:
      # 1. Remove the SCM_DO_BUILD_DURING_DEPLOYMENT app setting from your Azure App Service Environment variables.
      # 2. Refer to sample workflows for alternative deployment strategies: https://github.com/Azure/actions-workflow-samples/tree/master/AppService
      

  deploy:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: .
      
      - name: Verify and prepare package.json
        run: |
          # Check current directory structure after artifact download
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo ""
          echo "Searching for package.json in directory tree..."
          
          # Find package.json anywhere in the directory
          PKG_JSON=$(find . -name "package.json" -type f 2>/dev/null | head -1)
          
          if [ -z "$PKG_JSON" ]; then
            echo "ERROR: package.json not found anywhere!"
            echo "Full directory tree:"
            find . -type f -name "*.json" 2>/dev/null | head -20
            exit 1
          fi
          
          echo "âœ“ Found package.json at: $PKG_JSON"
          echo "Package.json contents (name field):"
          cat "$PKG_JSON" | grep -A 2 '"name"'
          
          # Ensure backend/ directory structure exists with package.json
          if [[ "$PKG_JSON" != "./backend/package.json" ]] && [[ "$PKG_JSON" != "backend/package.json" ]]; then
            echo "Note: package.json found at $PKG_JSON, ensuring backend/ structure..."
            mkdir -p backend
            
            # If package.json is in root, we need to check artifact structure
            # The artifact should have extracted backend/ folder, but let's verify
            if [ -f "package.json" ] && [ ! -f "backend/package.json" ]; then
              echo "Artifact structure issue: package.json in root instead of backend/"
              echo "This suggests the artifact was uploaded incorrectly."
              echo "Checking if we can find backend files..."
              if [ -f "server.js" ] || [ -d "routes" ]; then
                echo "Backend files found in root, creating backend structure..."
                mkdir -p backend
                [ -f "package.json" ] && mv package.json backend/ 2>/dev/null || true
                [ -f "package-lock.json" ] && mv package-lock.json backend/ 2>/dev/null || true
                [ -f "server.js" ] && mv server.js backend/ 2>/dev/null || true
                [ -d "routes" ] && mv routes backend/ 2>/dev/null || true
                [ -d "config" ] && mv config backend/ 2>/dev/null || true
                [ -d "middleware" ] && mv middleware backend/ 2>/dev/null || true
                [ -d "services" ] && mv services backend/ 2>/dev/null || true
              fi
            fi
          fi
          
          # Final verification - package.json must be in backend/
          if [ ! -f "backend/package.json" ]; then
            echo "ERROR: backend/package.json not found after preparation!"
            echo "Current directory structure:"
            find . -type f -name "package.json" 2>/dev/null
            exit 1
          fi
          
          echo "âœ“ Verified: backend/package.json exists"
          echo "Backend directory structure:"
          ls -la backend/ | head -10
      
      - name: Create Oryx configuration for Node.js
        run: |
          # Create .oryx file to explicitly specify Node.js (prevents Python detection)
          echo "PLATFORM_NAME=nodejs" > backend/.oryx
          echo "PLATFORM_VERSION=18" >> backend/.oryx
          echo "âœ“ Created .oryx configuration file"
          cat backend/.oryx
          
          # Also create oryx-manifest.toml
          cat > backend/oryx-manifest.toml << EOF
          # Oryx build manifest - explicitly specify Node.js
          [build]
          platform = "nodejs"
          platform_version = "18"
          EOF
          echo "âœ“ Created oryx-manifest.toml"
          
          # Verify package.json is present and valid
          echo "Verifying package.json:"
          cat backend/package.json | head -10
          
          # Remove any Python-related files that might confuse Oryx
          echo "Checking for Python files that might confuse Oryx:"
          find backend -name "requirements.txt" -o -name "*.py" 2>/dev/null | head -5 || echo "No Python files found (good!)"
      
      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'A000-Main-App'
          slot-name: 'Production'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_BCCDD66C2B2240B2B334EBFDA892DF8F }}
          package: './backend'
          type: zip
